---
layout: single
title: "[친절한SQL튜닝] 옵티마이저"
excerpt: "옵티마이저"
date: 2022-07-07T03:57:00+09:00
toc: true
toc_sticky: true
categories:
  - DB 
tags:
  - DB
  - SQL
  - 친절한SQL튜닝
---
** 
*이 글은 (주)디비안 조시형 대표님의 [친절한SQL튜닝](http://www.kyobobook.co.kr/product/detailViewKor.laf?ejkGb=KOR&mallGb=KOR&barcode=9791196395704) 강의와 책을 바탕으로 공부한 내용을 정리한 글입니다.*
**

## SQL
**SQL**은 Structured Query Language의 줄임말로 구조적(structured), 집합적(set-based), 선언적(declarative)인 질의 언어이다.

## SQL 옵티마이저
**SQL 옵티마이저**는 사용자가 원하는 작업을 가장 효율적으로 수행할 수 있는 최적의 데이터 액세스 경로를 선택해 주는 DBMS의 핵심 엔진이다.<br>
옵티마이저의 최적화 단계는 다음과 같다.<br>
1. 사용자로부터 전달받은 쿼리를 수행하는 데 후보군이 될만한 실행계획 찾기
2. 데이터 딕셔너리에 미리 수집해 둔 오브젝트 통계 및 시스템 통계 정보를 이용해 각 실행계획의 예상비용 산정
3. 최적 비용을 나타내는 실행계획 선택

## 실행계획과 비용
**실행계획**은 SQL 옵티마이저가 생성한 처리 절차를 사용자가 확인할 수 있도록 트리 구조로 표현한 것이다. 쿼리 문을 작성한 후 Ctrl+E를 누르면 해당 쿼리문의 실행계획을 확인할 수 있다.

![image](https://user-images.githubusercontent.com/60471550/177612488-61a30889-547a-4922-9a21-164008f04d7e.png)

**비용**은 쿼리를 수행하는 동안 발생할 것으로 예상하는 I/O 횟수 또는 예상 소요시간을 표현한 값이다. 옵티마이저는 비용을 비교하여 가장 비용이 적은 실행계획을 선택하게 된다. 그런데 비용은 실측치가 아닌 예상치이기 때문에 실제 수행할 때 발생하는 I/O 또는 시간과 차이가 있다. 이러한 차이로 인해 옵티마이저가 최적의 경로를 찾지 못할 경우 힌트를 사용하면 더 효율적인 데이터 액세스 경로로 유도할 수 있다.

## 옵티마이저 행동에 영향을 미치는 요소
- SQL과 연산자 형태
- 인덱스, 클러스터 등
- 제약 설정
- 옵티마이저 힌트
- 통계 정보
- 옵티마이저 관련 파라미터
- DBMS 버전과 종류

## 옵티마이저 힌트
SQL 옵티마이저가 항상 최선의 선택을 하지는 않기 때문에 개발자가 아는 더 효율적인 데이터 액세스 경로가 있다면 옵티마이저 힌트를 통해 옵티마이저가 특정 실행계획을 선택하도록 할 수 있다.<br> 옵티마이저 힌트는 다음과 같이 사용한다.
```sql
/*+ 힌트 */ 
```
아래와 같이 힌트를 사용할 수도 있지만 힌트의 끝을 나타내지 않아 줄바꿈 오류를 유발하기 쉬우니 가급적 사용하지 않는 것이 좋다고 한다.
```sql
--+ 힌트
```
### 주의사항
- 힌트 괄호 안에서의 ,(콤마)의 사용은 유효하지만 힌트와 힌트 사이에서는 무효
```sql
/*+ INDEX(A A_X01) INDEX(B, B_X03) */ -> 유효
/*+ INDEX(C) FULL(D) */ -> 무효
```
- 힌트 내에 스키마를 명시하면 무효
```sql
SELECT /*+ FULL(SCOTT.EMP) */ -> 무효
  FROM EMP
```
- FROM절에 ALIAS를 사용한 경우 힌트에도 ALIAS 사용 필수
```sql
SELECT /*+ FULL(E) */ -> 유효
  FROM EMP E
SELECT /*+ FULL(EMP) */ -> 무효
  FROM EMP E
```

힌트라는 단어가 옵티마이저가 경로를 선택하는데 있어 필수가 아닌 참고용인 것 같은 느낌을 주지만 옵티마이저는 힌트를 명령어로 인식한다. 옵티마이저가 힌트를 무시하는 경우가 있긴 하지만 이런 경우는 사용자가 힌트를 잘못 사용한 것이니 힌트가 적용이 안된다면 내가 쓴 힌트가 올바르게 작성됐는지 확인해보자.

## 자주 사용하는 힌트 목록
![image](https://user-images.githubusercontent.com/60471550/177622341-a5b24270-7a59-4ddc-bfa9-b9ad484cae1b.png)
![image](https://user-images.githubusercontent.com/60471550/177622371-58ef3495-b7c9-4b72-8a52-5942aaabd93c.png)